(function(root){function call(callbacks,args,traces){H.every(callbacks,function(callback){callback.apply(this,args)},traces)}function parseHeaders(headerString){for(var hs=(headerString||"").split("\r\n")||[],rs={},i=0;i<hs.length;i++){var f=(hs[i]||"").indexOf(":");-1!==f&&(rs[hs[i].substring(0,f)]=hs[i].substring(f+1,hs[i].length).trim())}return rs}"undefined"!=typeof module&&module.exports&&(root=GLOBAL);var N={};root.serverPath=N.serverPath="http://dev.indoorstar.com/ids/",root.dataServer=N.dataServer="http://indoorstar.com:6601/",root.innerServer=N.innerServer="http://dev.indoorstar.com:6603/ids/",root.newInnerServer=N.newInnerServer="http://dev.indoorstar.com:6630/ids/",root.newInnerWeb=N.newInnerWeb="http://dev.indoorstar.com:6630/web/",root.wxServerPath=N.wxServerPath="https://qyapi.weixin.qq.com/cgi-bin/",N.isJsonStart=function(d){if(!d)return!1;var c=d.charAt(0);return"{"===c||"["===c||'"'===c||"'"===c},N.inspectData=function(data){if(!data)return"buffer";if(N.isJsonStart(data)){var d=JSON.parse(data);return void 0!==d.s&&d.s<0?"actionfail":void 0!==d.d&&N.isJsonStart(d.d)?"actionjson":void 0!==d.d?"actionraw":"json"}return"rawdata"},N.dataHandlers={gzipped:function(d){try{return window.E.ungzip(d)}catch(e){throw H.log("UNGZIP ERROR"),e}},actionraw:function(d){var rd=JSON.parse(d);if(!rd.d)return rd.d;try{var dec=window.E.decode(rd.d);return N.isJsonStart(dec)?JSON.parse(dec):dec}catch(e){throw H.log("DECODE ACTIONRAW ERROR: "+e.toLocaleString()),e}},actionjson:function(d){var j=void 0;try{j=JSON.parse(JSON.parse(decodeURI(d)).d)}catch(e){try{j=JSON.parse(JSON.parse(d).d)}catch(e){throw H.log("JSON PARSE ERROR: "+e),e}}return j},action:function(d){if(!d)return d;var hdl=N.inspectData(d);return"actionjson"!==hdl&&"actionfail"!==hdl&&"actionraw"!==hdl&&(hdl="actionfail"),N.dataHandlers[hdl](d)},json:function(d){return d?N.isJsonStart(d)?"object"==typeof d?d:JSON.parse(d):void 0:d},rawdata:function(d){return d},actionfail:function(){return"&&actionfail"},encoded:function(d){try{return window.E.decode(d)}catch(e){throw H.log("DECODE RAW ERROR: "+e.toLocaleString()),e}},buffer:function(arrayBuffer){"use strict";return!arrayBuffer instanceof ArrayBuffer&&H.log("RESULT TYPE ERROR: NOT AN ARRAYBUFFER"),arrayBuffer}},N.request=function(url){if((url=url||location.href).length>=4&&"http"===url.substr(0,4)&&H.likeIE&&H.getIE()<10){var targetOrigin=url.split("#")[0].split("//")[0]+"//"+url.split("#")[0].split("//")[1].split("/")[0];if(location.protocol+"//"+location.hostname+(location.port||"")!==targetOrigin&&window.XDomainRequest)try{return new window.XDomainRequest}catch(e){}}if(window.XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(ee){}}return{open:function(){throw new Error("XHR Not Supported!")},setRequestHeader:H.noop(),send:H.noop()}},N.prepareRequest=function(url,options,data,resultType){options=options||{},data=data||{};var req={};req.request=N.request(url);var handler,isBuffer="buffer"===resultType;resultType&&(handler=N.dataHandlers[resultType]);var trace=H.getStackTrace();if(!req.request instanceof XMLHttpRequest&&isBuffer)return H.log("internal error: using TypedArray in no-XHR2 environment."),null;req.open=function(){req.request.open()},req.cancel=function(){req.request.abort()},req.cb=[],req.ecb=[],req.tcb=[],req.scb=[],req.sdcb=[],req.xcb=[],req.on=function(event,callback){switch(event){case"finish":req.cb.push(callback);break;case"error":req.ecb.push(callback);break;case"chunk":case"trunk":req.tcb.push(callback);break;case"start":req.scb.push(callback);break;case"started":req.sdcb.push(callback);break;case"exception":req.xcb.push(callback)}};var method=options.method||"GET",async=void 0===options.async?1:options.async;try{window.XDomainRequest&&req.request instanceof window.XDomainRequest&&(req.request.onerror=function(){call(req.ecb,[trace,req],[trace])},req.request.onprogress=function(){req.headers?call(req.tcb,[isBuffer?req.request.response:req.request.responseText,req],[trace]):(req.headers=parseHeaders(req.request.getAllResponseHeaders()),call(req.scb,[req],[trace]),call(req.tcb,[isBuffer?req.request.response:req.request.responseText,req],[trace]),call(req.sdcb,[req],[trace]))},req.request.ontimeout=function(){},req.request.timeout=0,req.request.onload=function(){var first=!req.headers;first&&(req.headers=parseHeaders(req.request.getAllResponseHeaders()),call(req.scb,[req],[trace])),handler||(handler=N.dataHandlers[N.inspectData(req.request.responseText)]);var d=handler(req.request.responseText);void 0!==d&&null!==d&&"&&actionfail"!==d?call(req.cb,[d,req],[trace]):call(req.ecb,[d,trace,req],[trace]),first&&call(req.sdcb,[req],[trace])})}catch(e){H.log("Ajax Error (XDR): "+e)}if(req.request.onreadystatechange=function(){if(3===req.request.readyState)req.headers?(!H.likeIE||H.getIE()>7)&&call(req.tcb,[isBuffer?req.request.response:req.request.responseText,req],[trace]):(req.headers=parseHeaders(req.request.getAllResponseHeaders()),call(req.scb,[req],[trace]),(!H.likeIE||H.getIE()>7)&&call(req.tcb,[isBuffer?req.request.response:req.request.responseText,req],[trace]),call(req.sdcb,[req],[trace]));else if(4!==req.request.readyState||200!==req.request.status&&0!==req.request.status)4===req.request.readyState&&call(req.ecb,[trace,req],[trace]);else{handler||(handler=N.dataHandlers[N.inspectData(req.request.responseText)]);var d=handler(isBuffer?req.request.response:req.request.responseText);void 0!==d&&null!==d&&"&&actionfail"!==d?call(req.cb,[d,req],[trace]):call(req.ecb,[req.request.response,trace,req],[trace])}},isBuffer){if("string"!=typeof req.request.responseType)return trace=H.getStackTrace(new Error("ArrayBuffer as responseType Not Supported!")),req.send=function(){call(req.ecb,[null,trace,req],[trace])},req;req.request.responseType="arraybuffer"}req.request.open(method,url,async),req.setRange=function(start,end){start=~~start,end=~~end,isNaN(start)||isNaN(end)||req.request.setRequestHeader("Range","bytes="+start+"-"+end)};var send=function(){"POST"===method?!window.XDomainRequest||window.XDomainRequest&&!req.request instanceof window.XDomainRequest?(req.request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),setTimeout(function(){req.request.send(H.param(data))},0)):setTimeout(function(){1===req.request.readyState&&req.request.send(H.param(data))},0):window.XDomainRequest&&req.request instanceof window.XDomainRequest?setTimeout(function(){req.request.send(null)},0):setTimeout(function(){1===req.request.readyState&&req.request.send(null)},0)};return req.send=function(){try{send()}catch(e){call(req.xcb,[e,trace,req],[trace])}},req},N.req=N.ajax=function(url,options,data,callback,resultType,errcallback,trunkcallback){var request=N.prepareRequest(url,options,data,resultType);return callback&&request.on("finish",callback),trunkcallback&&request.on("chunk",trunkcallback),errcallback&&request.on("error",errcallback),request.send(),request},N.get=function(url,callback,errback,type,async){return N.ajax(url,{method:"GET",async:!!async||!0},null,callback,type,errback)},N.WXajax=function(url,options,data,callback,resultType,errcallback,trunkcallback){var request=N.prepareRequest(url,options,data,resultType);return callback&&request.on("finish",callback),trunkcallback&&request.on("chunk",trunkcallback),errcallback&&request.on("error",errcallback),request.dataType="JSONP",request.send(),request},N.post=function(url,data,callback,errcb,type,async){return N.ajax(url,{method:"POST",async:!!async||!0},data,callback,type,errcb)},N.getAction=function(action,params,callback,errcb){return N.get(H.getUrlByParams(N.newInnerServer,action,params),function(d,req){void 0!==d.s?0===d.s?callback(d,req):errcb(d,req):callback(d,req)},errcb,"action")},N.WXGetAction=function(action,params,sucback,errback){return N.WXajax(H.getUrlByParams(N.wxServerPath,action,params),{method:"GET",async:!0},null,function(msg){sucback(msg)},"action",errback)},N.postAction=function(action,params,data,callback,errcb){return N.post(H.getUrlByParams(N.serverPath,action,params),data,callback,errcb,"action")},N.cGetAction=function(server,action,params,callback,errcb){return N.get(H.getUrlByParams(server,action,params),callback,errcb,"action")},N.cPostAction=function(server,action,params,data,callback,errcb){return N.post(H.getUrlByParams(server,action,params),callback,errcb,"action")},setInterval(function(){if(N.sequence&&N.sequence.length>0)if(N.sequenceBlocked)N.sequenceRequest||(N.sequenceBlocked=!1);else{var p=N.sequence[0];N.sequenceBlocked=!0,N.sequenceRequest=N.getAction(p.action,p.params,function(data){N.sequence.shift(),N.sequenceRequest=null,N.sequenceBlocked=!1,p.callback(data)},function(){N.sequence[0].tried=(N.sequence[0].tried||0)+1,3===N.sequence[0].tried&&(N.sequence.shift(),H.log("action failed after tried 3 times: "+p.action)),N.sequenceRequest=null,N.sequenceBlocked=!1,H.log("error")})}},50),N.sequenceAction=function(action,params,callback,errcb){N.sequence=N.sequence||[],N.sequence.push({action:action,params:params,callback:callback,errcb:errcb})},"function"==typeof define&&define.amd&&define("N",["H","E"],function(){}),"undefined"!=typeof module&&module.exports&&(module.exports=N),root.N=N}).call(this,this);